## ðŸ§± Project Architecture
This project follows a modular, reproducible layout:

```sh
.
â”œâ”€â”€ bin/                         # Optional local blobs/firmware
â”‚   â”œâ”€â”€ brcmfmac4366c-pcie.bin   # Broadcom Wi-Fi firmware (local takes precedence)
â”‚   â”œâ”€â”€ dhd.ko                   # (optional) Broadcom kernel module
â”‚   â””â”€â”€ FW_*.zip                 # Original archives (optional)
â”œâ”€â”€ config/                      # Config sources (templates & units)
â”‚   â”œâ”€â”€ allowlist/
â”‚   â”‚   â”œâ”€â”€ whitelist.txt        # Allowed domains â†’ ipset "whitelist"
â”‚   â”‚   â””â”€â”€ allow_all_ips.txt    # Client IPs allowed everywhere â†’ ipset "allow_all"
â”‚   â”œâ”€â”€ dnsmasq/
â”‚   â”‚   â”œâ”€â”€ wifi-ap.conf         # AP template (envsubst â†’ /etc/dnsmasq.d/wifi-ap.conf)
â”‚   â”‚   â””â”€â”€ whitelist.conf       # (generated) domainâ†’ipset mapping (â†’ /etc/dnsmasq.d/)
â”‚   â”œâ”€â”€ hostapd/
â”‚   â”‚   â””â”€â”€ hostapd.conf         # Template (envsubst â†’ /etc/hostapd/hostapd.conf)
â”‚   â”œâ”€â”€ netplan/
â”‚   â”‚   â””â”€â”€ 60-br0.yaml.tpl      # Bridge template (bridge mode)
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ hostapd.service      # Optional custom systemd unit
â”‚       â””â”€â”€ ipset-restore.service# Restore ipsets at boot
â”œâ”€â”€ docs/                        # User/dev documentation
â”‚   â”œâ”€â”€ allowlist.md architecture.md cleanup.md installation.md logging.md â€¦
â”œâ”€â”€ lib/                         # Shared Bash utilities
â”‚   â”œâ”€â”€ colors.sh
â”‚   â”œâ”€â”€ logger.sh                # Debug-level style logger + daily files
â”‚   â””â”€â”€ utils.sh                 # Helpers (source_as, etc.)
â”œâ”€â”€ logs/                        # Daily logs (YYYY-MM-DD.log)
â”œâ”€â”€ scripts/                     # Atomic, idempotent steps
â”‚   â”œâ”€â”€ 000_dependencies.sh      # Dependencies (context-aware, non-interactive)
â”‚   â”œâ”€â”€ 010_env.sh               # Detect IFs + defaults â†’ writes .env
â”‚   â”œâ”€â”€ 020_firmware.sh          # Broadcom firmware install + modprobe
â”‚   â”œâ”€â”€ 030_network.sh           # router: runtime AP IP | bridge: netplan/NM
â”‚   â”œâ”€â”€ 040_hostapd.sh           # Build/apt hostapd + render config + unit
â”‚   â”œâ”€â”€ 050_dnsmasq.sh           # (router) render, test, restart dnsmasq
â”‚   â”œâ”€â”€ 060_nat.sh               # (router) IPv4 forward + NAT, persistent
â”‚   â”œâ”€â”€ 070_allowlist.sh         # ipset + domain mapping + FORWARD chain
â”‚   â”œâ”€â”€ 080_services.sh          # Orchestrate services (dnsmasq/hostapd/ipset)
â”‚   â””â”€â”€ 090_doctor.sh            # Diagnostics (mode-aware)
â”œâ”€â”€ init.sh                      # Runs the install pipeline (scripts/000 â†’ 090)
â””â”€â”€ start.sh                     # Runtime helpers / (re)apply on boot if needed
```

### ðŸ”§ Modes & Backends

* `NET_MODE`: `router` (default) or `bridge`.
* `NET_BACKEND`: `netplan` (default) or `nm` (NetworkManager) for bridge mode.

These (and more) are written/augmented by `scripts/010_env.sh` into `.env`. You can edit `.env` and rerun `init.sh`.

### ðŸ§ª Install Pipeline

`./init.sh` executes, in order:

1. **000\_dependencies** â€” install required packages (idempotent, non-interactive).
2. **010\_env** â€” detect `ETHERNET_IF` / `WIRELESS_IF`, set sane defaults, write `.env`.
3. **020\_firmware** â€” install `brcmfmac4366c-pcie.bin` (local or linux-firmware), reload module.
4. **030\_network** â€”

   * `router`: assign `AP_CIDR` to `WIRELESS_IF` **at runtime**.
   * `bridge`: create `br0` via **netplan** (or **nm** if `NET_BACKEND=nm`).
5. **040\_hostapd** â€” build or apt install; render `config/hostapd/hostapd.conf` (envsubst); install unit (donâ€™t start).
6. **050\_dnsmasq** â€” (router) render `wifi-ap.conf`, sanitize bind options, `--test`, restart.
7. **060\_nat** â€” (router) enable IPv4 forward (sysctl.d), add NAT `MASQUERADE` + persist rules.
8. **070\_allowlist** â€” create/populate ipsets, generate `/etc/dnsmasq.d/whitelist.conf`, add `WIFI_ALLOWLIST` chain.
9. **080\_services** â€” enable/start `dnsmasq` (router) and `hostapd`, ensure `ipset-restore` if present.
10. **090\_doctor** â€” diagnostics (hostapd/dnsmasq/NAT/ipsets), quick DNS tests, logs.

### ðŸ—‚ï¸ Files created on the system

* `/etc/hostapd/hostapd.conf` â† rendered from `config/hostapd/hostapd.conf`.
* `/etc/dnsmasq.d/wifi-ap.conf` â† rendered from `config/dnsmasq/wifi-ap.conf`.
* `/etc/dnsmasq.d/whitelist.conf` â† generated by `070_allowlist.sh`.
* `/etc/systemd/system/hostapd.service` â† installed if your custom unit is provided.
* `/etc/systemd/system/ipset-restore.service` â† installed if provided.
* `/etc/sysctl.d/99-wifi-ap.conf` â† `net.ipv4.ip_forward=1` (router).
* `/etc/iptables/rules.v4` (if iptables-persistent is present) â† saved NAT/forward rules.

### âš™ï¸ Key `.env` variables

```sh
# --- mode & backend ---
export NET_MODE=router             # router | bridge
export NET_BACKEND=netplan         # netplan | nm

# --- interfaces ---
export ETHERNET_IF                 # automatically detected if empty
export WIRELESS_IF=                # automatically detected if empty
export BRIDGE_IF=br0

# --- sub-network AP (router mode) ---
export AP_CIDR=10.0.0.1/24
export AP_IP=10.0.0.1
export AP_NET=10.0.0
export DHCP_START=10.0.0.10
export DHCP_END=10.0.0.200

# --- hostapd ---
export WIRELESS_SSID="MyAP"
export WIRELESS_PASSWORD="ChangeMe123!"
export WIRELESS_COUNTRY="FR"
export CHANNEL=36

```

> Tip: run `010_env.sh` to initialize `.env`. Edit it as needed, then re-run `init.sh`.
> Each script is idempotent and safe to replay.
